// Test GCP SDK Library
import "gcp"

fn main() {
    print("========================================");
    print("   CRYO GCP SDK LIBRARY TEST");
    print("========================================");
    
    let passed = 0;
    let failed = 0;
    
    // Test 1: Initialize GCP
    print("");
    print("[TEST 1] Initialize GCP");
    gcpInit("my-gcp-project", "us-central1");
    
    let config = gcpGetConfig();
    if (config["projectId"] == "my-gcp-project" && config["region"] == "us-central1") {
        print("  ✓ PASS: GCP initialized");
        print("  Project: " + config["projectId"]);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Configuration incorrect");
        failed = failed + 1;
    }
    
    // Test 2: Pub/Sub Create Topic
    print("");
    print("[TEST 2] Pub/Sub Create Topic");
    let topicResult = pubsubCreateTopic("test-topic");
    
    if (topicResult["success"]) {
        print("  ✓ PASS: Topic created");
        print("  Name: " + topicResult["name"]);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Topic creation failed");
        failed = failed + 1;
    }
    
    // Test 3: Pub/Sub Publish and Subscribe
    print("");
    print("[TEST 3] Pub/Sub Publish and Subscribe");
    pubsubCreateSubscription("test-topic", "test-subscription");
    pubsubPublish("test-topic", "Hello Pub/Sub!", null);
    let pullResult = pubsubPull("test-subscription", 10);
    
    if (pullResult["success"] && pullResult["count"] >= 1) {
        print("  ✓ PASS: Message published and received");
        print("  Messages: " + pullResult["count"]);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Message not received");
        failed = failed + 1;
    }
    
    // Test 4: Firestore Set Document
    print("");
    print("[TEST 4] Firestore Set Document");
    let userData = {};
    userData["name"] = "Alice";
    userData["email"] = "alice@example.com";
    
    let setResult = firestoreSetDocument("users", "user123", userData);
    
    if (setResult["success"]) {
        print("  ✓ PASS: Document created");
        print("  Path: " + setResult["path"]);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Document creation failed");
        failed = failed + 1;
    }
    
    // Test 5: Firestore Get Document
    print("");
    print("[TEST 5] Firestore Get Document");
    let getResult = firestoreGetDocument("users", "user123");
    
    if (getResult["success"] && getResult["found"]) {
        let doc = getResult["document"];
        if (doc["name"] == "Alice") {
            print("  ✓ PASS: Document retrieved");
            print("  Name: " + doc["name"]);
            passed = passed + 1;
        } else {
            print("  ✗ FAIL: Document data mismatch");
            failed = failed + 1;
        }
    } else {
        print("  ✗ FAIL: Document not found");
        failed = failed + 1;
    }
    
    // Test 6: Cloud Functions Deploy
    print("");
    print("[TEST 6] Cloud Functions Deploy");
    let deployResult = functionsDeployFunction("hello-function", "cryo1.0", "helloWorld");
    
    if (deployResult["success"]) {
        print("  ✓ PASS: Function deployed");
        print("  URL: " + deployResult["url"]);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Deployment failed");
        failed = failed + 1;
    }
    
    // Test 7: Cloud Functions Call
    print("");
    print("[TEST 7] Cloud Functions Call");
    let callResult = functionsCallFunction("hello-function", "{\"name\":\"World\"}");
    
    if (callResult["success"] && callResult["result"] == "OK") {
        print("  ✓ PASS: Function invoked");
        print("  ExecutionId: " + callResult["executionId"]);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Invocation failed");
        failed = failed + 1;
    }
    
    // Test 8: Cloud Storage
    print("");
    print("[TEST 8] Cloud Storage");
    gcsCreateBucket("my-test-bucket");
    gcsUploadObject("my-test-bucket", "test.txt", "Hello GCS!", "text/plain");
    let downloadResult = gcsDownloadObject("my-test-bucket", "test.txt");
    
    if (downloadResult["success"] && downloadResult["data"] == "Hello GCS!") {
        print("  ✓ PASS: Object uploaded and downloaded");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Storage operation failed");
        failed = failed + 1;
    }
    
    // Test 9: Secret Manager
    print("");
    print("[TEST 9] Secret Manager");
    secretManagerCreateSecret("api-key", "super-secret-key-123");
    let secretResult = secretManagerAccessSecret("api-key");
    
    if (secretResult["success"] && secretResult["payload"] == "super-secret-key-123") {
        print("  ✓ PASS: Secret created and accessed");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Secret access failed");
        failed = failed + 1;
    }
    
    // Test 10: Error Handling
    print("");
    print("[TEST 10] Error Handling");
    let notFoundResult = pubsubPublish("nonexistent-topic", "test", null);
    
    if (!notFoundResult["success"] && notFoundResult["error"] == "NOT_FOUND") {
        print("  ✓ PASS: Error handled correctly");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Error not handled");
        failed = failed + 1;
    }
    
    // Summary
    print("");
    print("========================================");
    print("   TEST SUMMARY");
    print("========================================");
    print("  Passed: " + passed);
    print("  Failed: " + failed);
    print("  Total:  " + (passed + failed));
    print("");
    
    if (failed == 0) {
        print("  ✓ ALL TESTS PASSED!");
    } else {
        print("  ✗ SOME TESTS FAILED");
    }
    
    return 0;
}
