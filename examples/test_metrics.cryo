// Test Metrics Collection Library
import "metrics"

fn main() {
    print("========================================");
    print("   CRYO METRICS LIBRARY TEST");
    print("========================================");
    
    let passed = 0;
    let failed = 0;
    
    // Initialize metrics with prefix
    metricsInit("myapp_");
    
    // Test 1: Counter Creation and Increment
    print("");
    print("[TEST 1] Counter Metrics");
    counterCreate("requests_total", "Total requests processed");
    counterInc("requests_total");
    counterInc("requests_total");
    counterAdd("requests_total", 5);
    
    let count = counterGet("requests_total");
    if (count == 7) {
        print("  ✓ PASS: Counter value = " + count);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Expected 7, got " + count);
        failed = failed + 1;
    }
    
    // Test 2: Gauge Metrics
    print("");
    print("[TEST 2] Gauge Metrics");
    gaugeCreate("temperature", "Current temperature");
    gaugeSet("temperature", 25);
    gaugeInc("temperature");
    gaugeInc("temperature");
    gaugeDec("temperature");
    
    let temp = gaugeGet("temperature");
    if (temp == 26) {
        print("  ✓ PASS: Gauge value = " + temp);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Expected 26, got " + temp);
        failed = failed + 1;
    }
    
    // Test 3: Histogram Creation
    print("");
    print("[TEST 3] Histogram Creation");
    histogramCreate("latency_ms", "Request latency in ms", null);
    
    let metric = metricsGetMetric("latency_ms");
    if (metric != null && metric["mtype"] == "histogram") {
        print("  ✓ PASS: Histogram created");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Histogram not created");
        failed = failed + 1;
    }
    
    // Test 4: Histogram Observe
    print("");
    print("[TEST 4] Histogram Observations");
    histogramObserve("latency_ms", 15);
    histogramObserve("latency_ms", 45);
    histogramObserve("latency_ms", 120);
    histogramObserve("latency_ms", 8);
    histogramObserve("latency_ms", 350);
    
    let stats = histogramStats("latency_ms");
    if (stats != null && stats["count"] == 5) {
        print("  ✓ PASS: Histogram count = " + stats["count"]);
        print("  Sum: " + stats["sum"] + ", Avg: " + stats["avg"]);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Histogram stats incorrect");
        failed = failed + 1;
    }
    
    // Test 5: Timer Helper
    print("");
    print("[TEST 5] Timer Helper");
    let timer = timerStart();
    let duration = timerEnd(timer);
    
    if (duration >= 0) {
        print("  ✓ PASS: Timer works");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Timer returned negative");
        failed = failed + 1;
    }
    
    // Test 6: HTTP Metrics
    print("");
    print("[TEST 6] HTTP Metrics");
    metricsHttpInit();
    
    if (metricsHas("http_requests_total") && metricsHas("http_request_duration_seconds")) {
        print("  ✓ PASS: HTTP metrics initialized");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: HTTP metrics missing");
        failed = failed + 1;
    }
    
    // Test 7: Record HTTP Request
    print("");
    print("[TEST 7] Record HTTP Request");
    metricsHttpRequest("GET", "/api/users", 200, 45);
    metricsHttpRequest("POST", "/api/users", 500, 120);
    
    let totalRequests = counterGet("http_requests_total");
    let totalErrors = counterGet("http_errors_total");
    
    if (totalRequests == 2 && totalErrors == 1) {
        print("  ✓ PASS: HTTP metrics recorded");
        print("  Total: " + totalRequests + ", Errors: " + totalErrors);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: HTTP counts wrong");
        failed = failed + 1;
    }
    
    // Test 8: Metric Existence Check
    print("");
    print("[TEST 8] Metric Existence");
    let exists = metricsHas("requests_total");
    let notExists = metricsHas("nonexistent_metric");
    
    if (exists && !notExists) {
        print("  ✓ PASS: Existence check works");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Existence check broken");
        failed = failed + 1;
    }
    
    // Summary
    print("");
    print("========================================");
    print("   TEST SUMMARY");
    print("========================================");
    print("  Passed: " + passed);
    print("  Failed: " + failed);
    print("  Total:  " + (passed + failed));
    print("");
    
    if (failed == 0) {
        print("  ✓ ALL TESTS PASSED!");
    } else {
        print("  ✗ SOME TESTS FAILED");
    }
    
    return 0;
}
