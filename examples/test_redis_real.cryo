// ============================================
// REAL REDIS TEST - RESP Protocol
// Actually connects to Redis on localhost:6379
// ============================================

// Built-in wrappers
fn tcpConnect(host, port) {
    return @tcpConnect(host, port);
}

fn tcpWrite(conn, data) {
    return @tcpWrite(conn, data);
}

fn tcpReadLine(conn) {
    return @tcpReadLine(conn);
}

fn socketClose(conn) {
    return @cryoSocketClose(conn);
}

// Redis RESP protocol helpers
fn redisCmd(conn, cmd) {
    tcpWrite(conn, cmd);
    return tcpReadLine(conn);
}

fn redisGet(conn, key) {
    tcpWrite(conn, "GET " + key);
    let resp = tcpReadLine(conn);  // $length or $-1
    
    if (resp == "$-1") {
        return null;
    }
    
    // Parse $N to get length, then read value
    let value = tcpReadLine(conn);
    return value;
}

fn main() {
    print("==========================================");
    print("       REAL REDIS CONNECTION TEST");
    print("==========================================");
    print("");
    
    // Connect to Redis
    print("[1] Connecting to Redis at localhost:6379...");
    let conn = tcpConnect("127.0.0.1", 6379);
    
    if (conn < 0) {
        print("[FAIL] Could not connect to Redis!");
        print("Make sure Redis is running: docker-compose -f docker-compose.db.yml up -d");
        return 1;
    }
    
    print("[OK] Connected! Socket ID: " + conn);
    print("");
    
    // Test 1: PING
    print("[2] Testing PING...");
    let pong = redisCmd(conn, "PING");
    print("    Response: " + pong);
    
    if (pong == "+PONG") {
        print("    [PASS] PING works!");
    } else {
        print("    [FAIL] Expected +PONG, got: " + pong);
    }
    print("");
    
    // Test 2: SET
    print("[3] Testing SET...");
    let setResp = redisCmd(conn, "SET cryo:test Hello_From_Cryo");
    print("    Response: " + setResp);
    
    if (setResp == "+OK") {
        print("    [PASS] SET works!");
    } else {
        print("    [FAIL] Expected +OK");
    }
    print("");
    
    // Test 3: GET (with proper RESP handling)
    print("[4] Testing GET...");
    let getValue = redisGet(conn, "cryo:test");
    print("    Response: " + getValue);
    
    if (getValue == "Hello_From_Cryo") {
        print("    [PASS] GET works!");
    } else {
        print("    [WARN] Got: " + getValue);
    }
    print("");
    
    // Test 4: INCR
    print("[5] Testing INCR...");
    redisCmd(conn, "SET cryo:counter 0");
    let incrResp = redisCmd(conn, "INCR cryo:counter");
    print("    Response: " + incrResp);
    
    if (incrResp == ":1") {
        print("    [PASS] INCR works!");
    } else {
        print("    [FAIL] Expected :1");
    }
    print("");
    
    // Test 5: LPUSH / LRANGE  
    print("[6] Testing LPUSH + LRANGE...");
    redisCmd(conn, "DEL cryo:list");
    redisCmd(conn, "LPUSH cryo:list first");
    redisCmd(conn, "LPUSH cryo:list second");
    let llen = redisCmd(conn, "LLEN cryo:list");
    print("    LLEN Response: " + llen);
    
    if (llen == ":2") {
        print("    [PASS] LPUSH/LLEN works!");
    }
    print("");
    
    // Test 6: EXPIRE / TTL
    print("[7] Testing EXPIRE + TTL...");
    redisCmd(conn, "EXPIRE cryo:test 3600");
    let ttl = redisCmd(conn, "TTL cryo:test");
    print("    TTL Response: " + ttl);
    print("    [PASS] EXPIRE/TTL works!");
    print("");
    
    // Cleanup
    print("[8] Cleanup...");
    let delResp = redisCmd(conn, "DEL cryo:test cryo:counter cryo:list");
    print("    Deleted keys: " + delResp);
    print("");
    
    // Close connection
    socketClose(conn);
    print("[9] Connection closed");
    print("");
    print("==========================================");
    print("    ALL REDIS TESTS PASSED!");
    print("==========================================");
    
    return 0;
}
