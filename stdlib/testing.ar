// ============================================
// ARGON STANDARD LIBRARY: TESTING (v2.19.0)
// Unit testing framework
// ============================================

// Test statistics
let _test_total = 0;
let _test_passed = 0;
let _test_failed = 0;
let _test_current_name = "";

// Start a test suite
fn testSuite(name) {
    print("");
    print("========================================");
    print("  TEST SUITE: " + name);
    print("========================================");
    _test_total = 0;
    _test_passed = 0;
    _test_failed = 0;
}

// Start a test case
fn test(name) {
    _test_current_name = name;
    _test_total = _test_total + 1;
}

// Assert that condition is true
fn assert(condition, msg) {
    if (condition) {
        _test_passed = _test_passed + 1;
        print("  [PASS] " + _test_current_name + ": " + msg);
        return true;
    }
    _test_failed = _test_failed + 1;
    print("  [FAIL] " + _test_current_name + ": " + msg);
    return false;
}

// Assert equality
fn assertEq(actual, expected, msg) {
    if (actual == expected) {
        _test_passed = _test_passed + 1;
        print("  [PASS] " + _test_current_name + ": " + msg);
        return true;
    }
    _test_failed = _test_failed + 1;
    print("  [FAIL] " + _test_current_name + ": " + msg);
    print("         Expected: " + expected);
    print("         Actual:   " + actual);
    return false;
}

// Assert not equal
fn assertNeq(actual, not_expected, msg) {
    if (actual != not_expected) {
        _test_passed = _test_passed + 1;
        print("  [PASS] " + _test_current_name + ": " + msg);
        return true;
    }
    _test_failed = _test_failed + 1;
    print("  [FAIL] " + _test_current_name + ": " + msg);
    print("         Should not be: " + not_expected);
    return false;
}

// Assert true
fn assertTrue(condition, msg) {
    return assert(condition, msg);
}

// Assert false
fn assertFalse(condition, msg) {
    return assert(condition == false, msg);
}

// Assert null
fn assertNull(value, msg) {
    if (value == null) {
        _test_passed = _test_passed + 1;
        print("  [PASS] " + _test_current_name + ": " + msg);
        return true;
    }
    _test_failed = _test_failed + 1;
    print("  [FAIL] " + _test_current_name + ": " + msg);
    print("         Expected null, got: " + value);
    return false;
}

// Assert not null
fn assertNotNull(value, msg) {
    if (value != null) {
        _test_passed = _test_passed + 1;
        print("  [PASS] " + _test_current_name + ": " + msg);
        return true;
    }
    _test_failed = _test_failed + 1;
    print("  [FAIL] " + _test_current_name + ": " + msg);
    print("         Expected non-null value");
    return false;
}

// Assert greater than
fn assertGt(actual, threshold, msg) {
    if (actual > threshold) {
        _test_passed = _test_passed + 1;
        print("  [PASS] " + _test_current_name + ": " + msg);
        return true;
    }
    _test_failed = _test_failed + 1;
    print("  [FAIL] " + _test_current_name + ": " + msg);
    print("         " + actual + " is not > " + threshold);
    return false;
}

// Assert less than
fn assertLt(actual, threshold, msg) {
    if (actual < threshold) {
        _test_passed = _test_passed + 1;
        print("  [PASS] " + _test_current_name + ": " + msg);
        return true;
    }
    _test_failed = _test_failed + 1;
    print("  [FAIL] " + _test_current_name + ": " + msg);
    print("         " + actual + " is not < " + threshold);
    return false;
}

// Assert greater than or equal
fn assertGte(actual, threshold, msg) {
    if (actual >= threshold) {
        _test_passed = _test_passed + 1;
        print("  [PASS] " + _test_current_name + ": " + msg);
        return true;
    }
    _test_failed = _test_failed + 1;
    print("  [FAIL] " + _test_current_name + ": " + msg);
    print("         " + actual + " is not >= " + threshold);
    return false;
}

// Assert less than or equal
fn assertLte(actual, threshold, msg) {
    if (actual <= threshold) {
        _test_passed = _test_passed + 1;
        print("  [PASS] " + _test_current_name + ": " + msg);
        return true;
    }
    _test_failed = _test_failed + 1;
    print("  [FAIL] " + _test_current_name + ": " + msg);
    print("         " + actual + " is not <= " + threshold);
    return false;
}

// Assert string contains
fn assertContains(haystack, needle, msg) {
    let i = 0;
    let h_len = len(haystack);
    let n_len = len(needle);
    
    if (n_len > h_len) {
        _test_failed = _test_failed + 1;
        print("  [FAIL] " + _test_current_name + ": " + msg);
        print("         '" + haystack + "' does not contain '" + needle + "'");
        return false;
    }
    
    while (i <= h_len - n_len) {
        let is_match = true;
        let j = 0;
        while (j < n_len) {
            if (haystack[i + j] != needle[j]) {
                is_match = false;
                j = n_len;
            } else {
                j = j + 1;
            }
        }
        if (is_match) {
            _test_passed = _test_passed + 1;
            print("  [PASS] " + _test_current_name + ": " + msg);
            return true;
        }
        i = i + 1;
    }
    
    _test_failed = _test_failed + 1;
    print("  [FAIL] " + _test_current_name + ": " + msg);
    print("         '" + haystack + "' does not contain '" + needle + "'");
    return false;
}

// End test suite and print summary
fn testSummary() {
    print("");
    print("========================================");
    print("  RESULTS");
    print("========================================");
    print("  Total:  " + _test_total);
    print("  Passed: " + _test_passed);
    print("  Failed: " + _test_failed);
    print("========================================");
    
    if (_test_failed == 0) {
        print("  ALL TESTS PASSED!");
    } else {
        print("  SOME TESTS FAILED!");
    }
    print("========================================");
    print("");
    
    return _test_failed == 0;
}

// Skip a test
fn testSkip(name, reason) {
    print("  [SKIP] " + name + ": " + reason);
}

// Mark test as TODO
fn testTodo(name) {
    print("  [TODO] " + name);
}
