// ============================================
// CRYO SWAGGER / OPENAPI DOCUMENTATION
// Generate API documentation from decorators
// Version: 1.0.0
// ============================================

let SWAGGER_VERSION = "1.0.0";
let OPENAPI_VERSION = "3.0.3";

// ============================================
// API INFO STRUCT
// ============================================

struct ApiInfo {
    title: string,
    version: string,
    description: string,
    contact_name: string,
    contact_email: string,
    license_name: string,
    license_url: string
}

struct ApiServer {
    url: string,
    description: string
}

struct ApiTag {
    name: string,
    description: string
}

struct ApiParameter {
    name: string,
    location: string,
    description: string,
    required: bool,
    schema_type: string
}

struct ApiResponse {
    status_code: int,
    description: string,
    content_type: string
}

struct ApiEndpoint {
    path: string,
    method: string,
    summary: string,
    description: string,
    tags: any,
    parameters: any,
    responses: any
}

struct SwaggerSpec {
    info: ApiInfo,
    servers: any,
    tags: any,
    endpoints: any
}

// ============================================
// SWAGGER BUILDER
// ============================================

fn swaggerNew(title, version) {
    return SwaggerSpec {
        info: ApiInfo {
            title: title,
            version: version,
            description: "",
            contact_name: "",
            contact_email: "",
            license_name: "MIT",
            license_url: ""
        },
        servers: [],
        tags: [],
        endpoints: []
    };
}

fn swaggerSetDescription(spec, description) {
    spec.info.description = description;
    return spec;
}

fn swaggerSetContact(spec, name, email) {
    spec.info.contact_name = name;
    spec.info.contact_email = email;
    return spec;
}

fn swaggerSetLicense(spec, name, url) {
    spec.info.license_name = name;
    spec.info.license_url = url;
    return spec;
}

fn swaggerAddServer(spec, url, description) {
    push(spec.servers, ApiServer { url: url, description: description });
    return spec;
}

fn swaggerAddTag(spec, name, description) {
    push(spec.tags, ApiTag { name: name, description: description });
    return spec;
}

// ============================================
// ENDPOINT BUILDER
// ============================================

fn endpointNew(method, path, summary) {
    return ApiEndpoint {
        path: path,
        method: method,
        summary: summary,
        description: "",
        tags: [],
        parameters: [],
        responses: []
    };
}

fn endpointDescription(ep, desc) {
    ep.description = desc;
    return ep;
}

fn endpointTag(ep, tag) {
    push(ep.tags, tag);
    return ep;
}

fn endpointParamPath(ep, name, description, schema_type) {
    push(ep.parameters, ApiParameter {
        name: name,
        location: "path",
        description: description,
        required: true,
        schema_type: schema_type
    });
    return ep;
}

fn endpointParamQuery(ep, name, description, schema_type, required) {
    push(ep.parameters, ApiParameter {
        name: name,
        location: "query",
        description: description,
        required: required,
        schema_type: schema_type
    });
    return ep;
}

fn endpointResponse(ep, status_code, description, content_type) {
    push(ep.responses, ApiResponse {
        status_code: status_code,
        description: description,
        content_type: content_type
    });
    return ep;
}

fn swaggerAddEndpoint(spec, ep) {
    push(spec.endpoints, ep);
    return spec;
}

// ============================================
// JSON GENERATION
// ============================================

fn swaggerToJson(spec) {
    let json = "{\n";
    json = json + "  \"openapi\": \"" + OPENAPI_VERSION + "\",\n";
    
    // Info
    json = json + "  \"info\": {\n";
    json = json + "    \"title\": \"" + spec.info.title + "\",\n";
    json = json + "    \"version\": \"" + spec.info.version + "\",\n";
    json = json + "    \"description\": \"" + escapeJson(spec.info.description) + "\"";
    if (spec.info.contact_name != "") {
        json = json + ",\n    \"contact\": {\n";
        json = json + "      \"name\": \"" + spec.info.contact_name + "\",\n";
        json = json + "      \"email\": \"" + spec.info.contact_email + "\"\n";
        json = json + "    }";
    }
    if (spec.info.license_name != "") {
        json = json + ",\n    \"license\": {\n";
        json = json + "      \"name\": \"" + spec.info.license_name + "\"";
        if (spec.info.license_url != "") {
            json = json + ",\n      \"url\": \"" + spec.info.license_url + "\"";
        }
        json = json + "\n    }";
    }
    json = json + "\n  },\n";
    
    // Servers
    json = json + "  \"servers\": [\n";
    let i = 0;
    while (i < len(spec.servers)) {
        let srv = spec.servers[i];
        json = json + "    {\n";
        json = json + "      \"url\": \"" + srv.url + "\",\n";
        json = json + "      \"description\": \"" + srv.description + "\"\n";
        json = json + "    }";
        if (i < len(spec.servers) - 1) {
            json = json + ",";
        }
        json = json + "\n";
        i = i + 1;
    }
    json = json + "  ],\n";
    
    // Tags
    if (len(spec.tags) > 0) {
        json = json + "  \"tags\": [\n";
        i = 0;
        while (i < len(spec.tags)) {
            let tag = spec.tags[i];
            json = json + "    {\n";
            json = json + "      \"name\": \"" + tag.name + "\",\n";
            json = json + "      \"description\": \"" + tag.description + "\"\n";
            json = json + "    }";
            if (i < len(spec.tags) - 1) {
                json = json + ",";
            }
            json = json + "\n";
            i = i + 1;
        }
        json = json + "  ],\n";
    }
    
    // Paths
    json = json + "  \"paths\": {\n";
    i = 0;
    while (i < len(spec.endpoints)) {
        let ep = spec.endpoints[i];
        json = json + generateEndpointJson(ep);
        if (i < len(spec.endpoints) - 1) {
            json = json + ",\n";
        } else {
            json = json + "\n";
        }
        i = i + 1;
    }
    json = json + "  }\n";
    
    json = json + "}";
    return json;
}

fn generateEndpointJson(ep) {
    let json = "    \"" + ep.path + "\": {\n";
    json = json + "      \"" + lowercase(ep.method) + "\": {\n";
    json = json + "        \"summary\": \"" + escapeJson(ep.summary) + "\",\n";
    
    if (ep.description != "") {
        json = json + "        \"description\": \"" + escapeJson(ep.description) + "\",\n";
    }
    
    // Tags
    if (len(ep.tags) > 0) {
        json = json + "        \"tags\": [";
        let i = 0;
        while (i < len(ep.tags)) {
            json = json + "\"" + ep.tags[i] + "\"";
            if (i < len(ep.tags) - 1) {
                json = json + ", ";
            }
            i = i + 1;
        }
        json = json + "],\n";
    }
    
    // Parameters
    if (len(ep.parameters) > 0) {
        json = json + "        \"parameters\": [\n";
        let i = 0;
        while (i < len(ep.parameters)) {
            let param = ep.parameters[i];
            json = json + "          {\n";
            json = json + "            \"name\": \"" + param.name + "\",\n";
            json = json + "            \"in\": \"" + param.location + "\",\n";
            json = json + "            \"description\": \"" + escapeJson(param.description) + "\",\n";
            json = json + "            \"required\": " + boolToString(param.required) + ",\n";
            json = json + "            \"schema\": { \"type\": \"" + param.schema_type + "\" }\n";
            json = json + "          }";
            if (i < len(ep.parameters) - 1) {
                json = json + ",";
            }
            json = json + "\n";
            i = i + 1;
        }
        json = json + "        ],\n";
    }
    
    // Responses
    json = json + "        \"responses\": {\n";
    if (len(ep.responses) > 0) {
        let i = 0;
        while (i < len(ep.responses)) {
            let resp = ep.responses[i];
            json = json + "          \"" + resp.status_code + "\": {\n";
            json = json + "            \"description\": \"" + escapeJson(resp.description) + "\"\n";
            json = json + "          }";
            if (i < len(ep.responses) - 1) {
                json = json + ",";
            }
            json = json + "\n";
            i = i + 1;
        }
    } else {
        json = json + "          \"200\": {\n";
        json = json + "            \"description\": \"Successful response\"\n";
        json = json + "          }\n";
    }
    json = json + "        }\n";
    
    json = json + "      }\n";
    json = json + "    }";
    
    return json;
}

fn escapeJson(s) {
    let result = "";
    let i = 0;
    while (i < len(s)) {
        let c = substr(s, i, 1);
        if (c == "\"") {
            result = result + "\\\"";
        } else if (c == "\\") {
            result = result + "\\\\";
        } else {
            result = result + c;
        }
        i = i + 1;
    }
    return result;
}

fn boolToString(b) {
    if (b) {
        return "true";
    }
    return "false";
}

fn lowercase(s) {
    if (s == "GET") { return "get"; }
    if (s == "POST") { return "post"; }
    if (s == "PUT") { return "put"; }
    if (s == "DELETE") { return "delete"; }
    if (s == "PATCH") { return "patch"; }
    return s;
}

// ============================================
// SWAGGER UI HTML
// ============================================

fn swaggerUiHtml(spec_json, title) {
    return "<!DOCTYPE html>
<html>
<head>
    <title>" + title + " - API Docs</title>
    <link rel=\"stylesheet\" href=\"https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui.css\">
</head>
<body>
    <div id=\"swagger-ui\"></div>
    <script src=\"https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui-bundle.js\"></script>
    <script>
        SwaggerUIBundle({
            spec: " + spec_json + ",
            dom_id: '#swagger-ui'
        });
    </script>
</body>
</html>";
}
